#!/usr/bin/env bash
set -euo pipefail

# validate-template - Validates template integrity and configuration
# Usage: ./bin/validate-template

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ERRORS=0
WARNINGS=0

error() {
    echo -e "${RED}✗${NC} $1"
    ((ERRORS++))
}

warn() {
    echo -e "${YELLOW}⚠${NC} $1"
    ((WARNINGS++))
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

show_help() {
    cat << EOF
validate-template v${VERSION}

Validates the Elixir project template integrity and configuration.

USAGE:
    ./bin/validate-template [OPTIONS]

OPTIONS:
    -h, --help              Show this help message
    -v, --version           Show version
    --verbose               Show detailed validation output

DESCRIPTION:
    This script validates:
    - Required files and directories exist
    - Configuration files have valid syntax
    - No placeholder values remain
    - Git repository is initialized
    - Version management files exist

EXIT CODES:
    0   All validations passed
    1   Validation errors found
    2   Warnings found (non-critical)

EXAMPLES:
    # Standard validation
    ./bin/validate-template

    # Verbose output
    ./bin/validate-template --verbose

EOF
}

VERBOSE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            echo "validate-template v${VERSION}"
            exit 0
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        *)
            error "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo ""
echo "=================================================="
echo "  Template Validation"
echo "  Version ${VERSION}"
echo "=================================================="
echo ""

cd "$PROJECT_ROOT"

# Check required files
info "Checking required files..."
REQUIRED_FILES=(
    "README.md"
    "CLAUDE.md"
    "ADAPTATION-GUIDE.md"
    "Makefile"
    ".gitignore"
    ".credo.exs"
    ".formatter.exs"
    ".doctor.exs"
    ".sobelow-conf"
    ".github/workflows/ci.yaml"
    ".github/workflows/quality-checks.yaml"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [ -f "$file" ]; then
        [ "$VERBOSE" = true ] && success "$file exists"
    else
        error "Missing required file: $file"
    fi
done

# Check required directories
info "Checking required directories..."
REQUIRED_DIRS=(
    "bin"
    "specs"
    "docs"
    ".claude/commands"
    ".claude/context"
)

for dir in "${REQUIRED_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        [ "$VERBOSE" = true ] && success "$dir/ exists"
    else
        error "Missing required directory: $dir/"
    fi
done

# Check executable scripts
info "Checking executable scripts..."
SCRIPTS=(
    "bin/setup-template"
    "bin/validate-template"
    "bin/create-project"
)

for script in "${SCRIPTS[@]}"; do
    if [ -f "$script" ]; then
        if [ -x "$script" ]; then
            [ "$VERBOSE" = true ] && success "$script is executable"
        else
            error "$script is not executable (run: chmod +x $script)"
        fi
    else
        warn "$script not found (optional)"
    fi
done

# Check YAML syntax
info "Checking YAML syntax..."
if command -v yamllint >/dev/null 2>&1; then
    for file in .github/workflows/*.yaml .github/workflows/*.yml 2>/dev/null; do
        if [ -f "$file" ]; then
            if yamllint -d relaxed "$file" >/dev/null 2>&1; then
                [ "$VERBOSE" = true ] && success "$file has valid YAML syntax"
            else
                error "$file has invalid YAML syntax"
            fi
        fi
    done
else
    warn "yamllint not installed, skipping YAML validation"
fi

# Check for placeholder content
info "Checking for placeholder content..."
if grep -r "customize this" . --exclude-dir=.git --exclude-dir=_build --exclude-dir=deps 2>/dev/null | grep -v "validate-template" >/dev/null; then
    warn "Found 'customize this' placeholder text - may need customization"
fi

if grep -q "This is an Elixir/Phoenix application. Customize this section" CLAUDE.md 2>/dev/null; then
    warn "CLAUDE.md contains generic Project Overview - consider customizing"
fi

# Check git repository
info "Checking git repository..."
if [ -d ".git" ]; then
    success "Git repository initialized"
else
    warn "Not a git repository (run: git init)"
fi

# Check version files
info "Checking version management..."
if [ -f ".tool-versions" ] || [ -f ".envrc" ] || [ -f ".tool-versions.example" ]; then
    success "Version management file found"
else
    warn "No version management file (.tool-versions, .envrc, or .tool-versions.example)"
fi

# Check Claude commands
info "Checking Claude Code commands..."
COMMANDS=(
    ".claude/commands/prime.md"
    ".claude/commands/start.md"
    ".claude/commands/plan-feature.md"
    ".claude/commands/plan-bug.md"
    ".claude/commands/plan-chore.md"
    ".claude/commands/implement-plan.md"
)

for cmd in "${COMMANDS[@]}"; do
    if [ -f "$cmd" ]; then
        [ "$VERBOSE" = true ] && success "$cmd exists"
    else
        error "Missing Claude command: $cmd"
    fi
done

# Summary
echo ""
echo "=================================================="
echo "  Validation Summary"
echo "=================================================="

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}✓ All checks passed!${NC}"
    echo ""
    info "Template is ready to use"
    exit 0
elif [ $ERRORS -eq 0 ]; then
    echo -e "${YELLOW}⚠ $WARNINGS warning(s) found${NC}"
    echo ""
    info "Template is usable but may need customization"
    exit 2
else
    echo -e "${RED}✗ $ERRORS error(s) found${NC}"
    [ $WARNINGS -gt 0 ] && echo -e "${YELLOW}⚠ $WARNINGS warning(s) found${NC}"
    echo ""
    error "Template has errors that must be fixed"
    exit 1
fi
